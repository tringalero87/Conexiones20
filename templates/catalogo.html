{% extends "base.html" %}

{#
    Este template renderiza la página del Catálogo de Conexiones.
    Permite a los usuarios seleccionar un proyecto y luego una tipología específica
    para iniciar el proceso de creación de una nueva conexión codificada.
#}

{% block content %}
<div class="page-header">
    <div>
        <h1>Catálogo de Conexiones</h1>
        <p class="text-secondary">Selecciona un proyecto y luego elige una tipología para crear una nueva conexión.</p>
    </div>
</div>

{#
    Contenedor principal para la lógica del catálogo.
    - data-base-url: Almacena la URL base para crear una conexión. JavaScript usará esto
      para construir la URL final con los parámetros correctos.
#}
<div id="catalogo-container"
     data-base-url="{{ url_for('conexiones.crear_conexion_form') }}">

    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label for="proyecto-select" class="form-label"><strong>Paso 1:</strong> Selecciona un Proyecto</label>
                    <select class="form-select form-select-lg" id="proyecto-select">
                        <option value="">-- Elige un proyecto --</option>
                        {# Se itera sobre la lista de 'proyectos' pasada desde la ruta de Flask. #}
                        {% for proyecto in proyectos %}
                        <option value="{{ proyecto.id }}" {{ 'selected' if proyecto.id == preselect_project_id }}>{{ proyecto.nombre|e }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-7">
                    <label for="search-input" class="form-label"><strong>Paso 2:</strong> Buscar Tipología</label>
                    {# Este campo está deshabilitado por defecto y se activa con JavaScript cuando se selecciona un proyecto. #}
                    <input type="text" id="search-input" class="form-control form-control-lg" placeholder="Buscar por nombre de la conexión..." disabled>
                </div>
            </div>
            {# Mensaje informativo si el usuario no tiene proyectos asignados. #}
            {% if not proyectos %}
            <div class="alert alert-warning mt-3">
                No tienes proyectos asignados. Por favor, contacta a un administrador para que te dé acceso a uno.
            </div>
            {% endif %}
        </div>
    </div>
    
    {#
        Esta sección está deshabilitada visualmente por defecto ('disabled-section').
        JavaScript le quitará esta clase cuando se seleccione un proyecto.
    #}
    <div id="tipologias-wrapper" class="disabled-section">
        <p class="mb-3"><strong>Paso 3:</strong> Selecciona una Tipología de Conexión</p>
        
        <div class="accordion" id="catalogoAccordion">
            {#
                Bucle principal que itera sobre la estructura del JSON de conexiones.
                'tipo' es la clave principal (ej: "MOMENTO", "CORTANTE").
                'subtipos_data' es el objeto que contiene la imagen y la lista de subtipos.
            #}
            {% for tipo, subtipos_data in estructura.items() %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
                        {{ tipo.replace('_', ' ')|title }}
                    </button>
                </h2>
                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#catalogoAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            {# Bucle anidado para iterar sobre los subtipos (ej: "VIGA-COLUMNA (ALA)") #}
                            {% for subtipo_key, subtipo_info in subtipos_data.subtipos.items() %}
                            <div class="col-md-12 mb-4">
                                <h5 class="subtipo-header">{{ subtipo_key|e }}</h5>
                                <div class="list-group">
                                    {# Bucle final para iterar sobre las tipologías específicas (ej: "T0", "T1") #}
                                    {% for tipologia in subtipo_info.tipologias %}
                                    <a href="#" 
                                       class="list-group-item list-group-item-action disabled tipologia-link"
                                       {#
                                           Atributos data-* para pasar la información necesaria a JavaScript
                                           cuando se hace clic en una tipología.
                                       #}
                                       data-tipo="{{ tipo }}"
                                       data-subtipo="{{ subtipo_key }}"
                                       data-tipologia="{{ tipologia.nombre }}">
                                        <div class="d-flex w-100 justify-content-start align-items-center">
                                            {# Imagen representativa de la tipología #}
                                            <img src="{{ url_for('static', filename='images/tipologias/' + tipologia.imagen) }}" 
                                                 class="me-3 rounded border"
                                                 style="width: 60px; height: 60px; object-fit: cover;"
                                                 alt="Imagen de la tipología {{ tipologia.nombre|e }}"
                                                 {# Placeholder en caso de que la imagen no cargue #}
                                                 onerror="this.onerror=null;this.src='https://placehold.co/60x60/343a40/dee2e6?text=?';">
                                            <div>
                                                <h6 class="mb-1 tipologia-name">{{ tipologia.nombre|e }}</h6>
                                                {# Muestra la descripción si existe en el JSON, de lo contrario muestra un texto por defecto. #}
                                                <small class="text-muted">{{ tipologia.get('descripcion', 'Descripción no disponible.') }}</small>
                                            </div>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
             {# Div para mostrar cuando la búsqueda no arroja resultados. Oculto por defecto. #}
             <div id="no-results" class="text-center p-5" style="display: none;">
                <i class="bi bi-search" style="font-size: 3rem;"></i>
                <h4 class="mt-3">No se encontraron resultados</h4>
                <p class="text-secondary">No se encontraron tipologías que coincidan con tu búsqueda.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}