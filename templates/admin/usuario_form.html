{% extends "base.html" %}

{#
    Este template renderiza el formulario para crear un nuevo usuario o para editar uno existente.
    La lógica se controla mediante la existencia de la variable 'usuario'.
    - 'titulo': Se pasa desde la ruta de Flask para el encabezado de la página.
    - 'form': Es el objeto del formulario Flask-WTF (UserForm) que gestiona los campos,
      la validación de datos y la protección contra ataques CSRF.
#}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ titulo }}</h1>
        <p class="text-secondary">Completa los datos para {{ 'crear un nuevo' if not usuario else 'actualizar el' }} usuario.</p>
    </div>
</div>

<div class="card">
    <div class="card-body p-4">
        
        {#
            El atributo 'novalidate' en el formulario previene la validación nativa del navegador,
            permitiendo que la validación del lado del servidor de Flask-WTF se encargue de todo.
        #}
        <form method="POST" action="" novalidate>
            
            {#
                form.hidden_tag() es una macro de Flask-WTF que renderiza cualquier campo oculto
                en el formulario. Es crucial porque incluye automáticamente el token CSRF,
                protegiendo la aplicación contra ataques de falsificación de solicitudes entre sitios.
            #}
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.nombre_completo.label(class="form-label fw-bold") }}
                    {#
                        Renderiza el campo <input type="text">.
                        - La clase 'is-invalid' de Bootstrap se añade condicionalmente si el campo
                          tiene errores de validación después de un envío fallido.
                    #}
                    {{ form.nombre_completo(class="form-control" + (" is-invalid" if form.nombre_completo.errors else "")) }}
                    {# Bucle para mostrar los mensajes de error de validación para este campo. #}
                    {% if form.nombre_completo.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.nombre_completo.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    {{ form.username.label(class="form-label fw-bold") }}
                    {# Campo username ahora es editable. Se hace readonly si es un usuario existente para evitar cambios accidentales y por si el modelo de negocio no permite cambiar el username. #}
                    {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), readonly=true if usuario else false) }}
                    {% if form.username.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.username.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% endif %}
                    {% if usuario %}
                    <small class="form-text text-muted">El nombre de usuario no puede ser cambiado.</small>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                {{ form.email.label(class="form-label fw-bold") }}
                {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                {% if form.email.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.email.errors %}<span>{{ error }}</span>{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.password.label(class="form-label fw-bold") }}
                    {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                    {% if form.password.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.password.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">
                        {% if usuario %}
                            Deja en blanco para no cambiar la contraseña actual.
                        {% else %}
                            Mínimo 6 caracteres.
                        {% endif %}
                    </small>
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.confirm_password.label(class="form-label fw-bold") }}
                    {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else "")) }}
                     {% if form.confirm_password.errors %}
                        <div class="invalid-feedback">
                           {% for error in form.confirm_password.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                {{ form.roles.label(class="form-label fw-bold") }}
                <div class="row">
                    {% for subfield in form.roles %}
                    <div class="col-md-3">
                        <div class="form-check">
                            {{ subfield(class="form-check-input") }}
                            {{ subfield.label(class="form-check-label") }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if form.roles.errors %}
                <div class="d-block invalid-feedback">
                    {% for error in form.roles.errors %}<span>{{ error }}</span>{% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="mb-4 form-check form-switch">
                {{ form.activo(class="form-check-input") }}
                {{ form.activo.label(class="form-check-label", for=form.activo.id) }}
            </div>
            
            <div class="d-flex justify-content-end border-top pt-3 mt-4">
                <a href="{{ url_for('admin.listar_usuarios') }}" class="btn btn-secondary me-3">Cancelar</a>
                {# Renderiza el botón de envío del formulario. #}
                {{ form.submit(class="btn btn-primary btn-lg") }}
            </div>
        </form>
    </div>
</div>
{% endblock %}